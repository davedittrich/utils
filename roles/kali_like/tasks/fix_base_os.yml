---
# Tasks file for preparing the base OS for installation of Kali
# tools. This includes installation of Kali package signing keys,
# package dependencies, normalizing OS commands to match Kali
# distros, etc.

- name: Ensure Kali package pre-requisites are present.
  ansible.builtin.apt:
    name: "{{ packages }}"
    state: present
    update_cache: true
    cache_valid_time: 3600
  vars:
    packages:
      - apt-utils
      - dirmngr
      - gnupg
      - gnupg2
      - python3-lib2to3
      - python3-six
      - xz-utils
  become: true

- name: Ensure `gawk` is installed.
  ansible.builtin.apt:
    name: gawk
    state: present
    update_cache: false
  register: gawk_result
  become: true

- name: Work around some bug regarding `/usr/bin/awk`. # noqa no-handler
  ansible.builtin.command: update-alternatives --set awk /usr/bin/gawk
  become: true
  changed_when: false
  when: gawk_result.changed

- name: Ensure Kali package signing key is present.
  ansible.builtin.apt_key:
    keyserver: pgpkeys.mit.edu
    id: ED444FF07D8D0BF6
    state: present
  become: true

- name: Add Kali sources to `/etc/apt/sources.list.d/`
  ansible.builtin.copy:
    content: |
      deb http://http.kali.org/kali kali-rolling main contrib non-free
      deb-src http://http.kali.org/kali kali-rolling main contrib non-free
    dest: "/etc/apt/sources.list.d/kali.list"
    owner: "root"
    group: "root"
    mode: 0o644
  register: sources
  become: true

- name: Ensure APT cache updated after adding Kali repos.
  ansible.builtin.apt:
    update-cache: true
  when: sources.changed
  become: true

# vim: ft=ansible :
