---

# Tasks file for davedittrich.utils.dropins role.

- name: Set fact with users whose accounts need to be configured.
  ansible.builtin.set_fact:
    accounts: "{{ accounts | default(['root', ansible_user_id]) | unique }}"

- name: Ensure user home directories are mapped.
  include_tasks: '{{ collection_root }}/tasks/get_homedir.yml'
  loop: '{{ accounts }}'
  loop_control:
    loop_var: user

- name: Ensure `dropin_files` is defined with files to be configured as dropin directories.
  ansible.builtin.set_fact:
    dropin_files: '{{ _dropin_files }}'
  when: dropin_files is not defined

- name: Debug `dropin_files` variable.
  ansible.builtin.debug:
    var: dropin_files
    verbosity: 0

- name: Ensure `pipx` present in user account.
  include_tasks:
    file: '{{ collection_root }}/tasks/check_repair_user_pipx.yml'
  loop: '{{ accounts }}'
  loop_control:
    loop_var: user

- name: Ensure `update-dotdee` present in user account via `pipx`.
  include_tasks:
    file: setup_update_dotdee.yml
  loop: '{{ accounts }}'
  loop_control:
    loop_var: user

# https://stackoverflow.com/questions/58110659/issue-passing-variable-to-include-task-file-having-add-host-in-ansible

- name: Ensure dropin directories are set up.
  include_tasks:
    file: setup_dropin.yml
  vars:
    user: '{{ item.0 }}'
    dropin_file: '{{ item.1 }}'
  with_nested:
    - '{{ accounts }}'
    - '{{ dropin_files }}'

- name: Ensure `PATH` is customized.
  include_tasks:
    file: ensure_path.yml
  loop: '{{ accounts }}'
  loop_control:
    loop_var: user
