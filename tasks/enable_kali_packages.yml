---
# Prepare system for installing packages from Kali repos.

- name: Ensure Kali package signing key is present.
  ansible.builtin.copy:
    src: ED444FF07D8D0BF6.asc
    dest: ED444FF07D8D0BF6.asc
    owner: root
    group: root
    mode: 0o600
  become: true

- name: Ensure Kali package signing key is enabled for APT.
  ansible.builtin.apt_key:
    id: ED444FF07D8D0BF6
    file: ED444FF07D8D0BF6.asc
    state: present
  become: true

- name: Ensure Kali sources in `/etc/apt/sources.list.d/kali.list`
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/kali.list
    content: |
      deb http://http.kali.org/kali kali-bleeding-edge main contrib non-free
      deb http://http.kali.org/kali kali-rolling main contrib non-free
      deb-src http://http.kali.org/kali kali-bleeding-edge main contrib non-free
      deb-src http://http.kali.org/kali kali-rolling main contrib non-free
    owner: root
    group: root
    mode: 0o644
  register: sources
  become: true

- name: Block for updating APT cache after policy change.
  block:

    - name: Ensure APT cache is updated for pre-requisites.
      ansible.builtin.apt:
        force_apt_get: true
        update-cache: true
        cache_valid_time: 0
      register: apt_update
      become: true

  rescue:
    - name: Ensure changes to `Suite` or `Version` are handled.
      ansible.builtin.shell:
        apt-get --allow-releaseinfo-change update
      args:
        executable: /bin/bash
      when:
        - "'InRelease' in apt_update.stdout"
        - "'changed its' in apt_update.stdout"
        - "'Suite' in apt_update.stdout or 'Version' in apt_update.stdout"
      become: true

    - name: Pause to debug APT result.
      ansible.builtin.pause:
        minutes: 10
      when:
        - stdout not in apt_update

# vim: ft=ansible :
