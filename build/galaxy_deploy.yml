---
# This playbook assumes that the `galaxy.yml` file has already been
# prepared in the current working directory of the process running
# this playbook, containing the current version number for the
# artifact to build or publish that matches the contents of the
# file `VERSION`.

- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    _no_log: "{{ _no_log | default(true) }}"
    cwd: "{{ lookup('env', 'PWD') }}"

  pre_tasks:
    - name: Set fact with version number.
      ansible.builtin.set_fact:
        version: '{{ lookup("file", "{{ cwd }}" + "/VERSION") }}'

    - name: Set fact with artifact name.
      ansible.builtin.set_fact:
        artifact_name: 'davedittrich-utils-{{ version }}.tar.gz'

    - name: Set fact `publish`.
      ansible.builtin.set_fact:
        publish: false
      when: publish is not defined

    - assert:
        that:
          - lookup('env', 'ANSIBLE_GALAXY_SERVER') != ''
          - lookup('env', 'ANSIBLE_GALAXY_API_KEY') != ''
      when: publish | bool

    - name: Debug build settings.
      ansible.builtin.debug:
        msg: '{{ item }}'
      loop:
        - "artifact_name={{ artifact_name }}"
        - "publish={{ publish | bool }}"
        - "version={{ version }}"

  tasks:
    - name: Block to build collection.
      block:

        - name: Build the collection.
          ansible.builtin.shell: >
            ansible-galaxy collection build --force &&
            ln -sf {{ artifact_name }} davedittrich-utils-latest.tar.gz
          args:
            chdir: '{{ cwd }}'
          register: collection_build

      rescue:
        - name: Debug collection_build.stderr_lines.
          ansible.builtin.debug:
            msg: "{{ collection_build.stderr_lines }}"
          when:
            - collection_build is defined
            - collection_build is failed

      always:
        - name: Get directory contents.
          ansible.builtin.shell: >
            tree -nhup -L 2
          args:
            chdir: '{{ cwd }}'
          register: tree

        - name: Debug tree output.
          ansible.builtin.debug:
            msg: "{{ tree.stdout_lines }}"

    - name: Block to publish collection.
      when: publish | bool
      block:

        - name: Publish the collection.
          ansible.builtin.shell: >
            ansible-galaxy collection publish -vvv
              {{ artifact_name }}
              --server {{ lookup('env', 'ANSIBLE_GALAXY_SERVER')  }}
              --api-key {{ lookup('env', 'ANSIBLE_GALAXY_API_KEY') }}
          args:
            chdir: '{{ cwd }}'
          no_log: '{{ _no_log }}'
          register: collection_publish
          when: publish | bool

      rescue:
        - name: Debug collection_publish.stderr_lines.
          ansible.builtin.debug:
            msg: "{{ collection_publish.stderr_lines }}"
          when:
            - collection_publish is defined
            - collection_publish is failed

        - ansible.builtin.fail:
            msg:
              - "[-] publish of {{ artifact_name }} failed"

# vim: ft=ansible:
